---
import NavBar from "@/components/navbar/NavBar.svelte";
import Brand from "@/components/Brand.astro";
import Sidebar from "@/components/sidebar/Sidebar.svelte";
import HeaderCover from "@/components/HeaderCover.astro";
import Waves from "@/components/Waves.svelte";
import Footer from "@/components/footer/Footer.astro";
import Widgets from "@/components/footer/Widgets.svelte";
import { getCollection } from "astro:content";
import type {
  TocItem,
  RelatedPost,
  QuickNavigation,
} from "@/components/sidebar/SidebarTypes";
import "@/styles/view-transition.css";
import "@vtbag/element-crossing?url";

import themeConfig from "@/theme.config.ts";

import "@/styles/palette.css";
import "@/styles/style.css";
import "@/styles/header-cover.css";
import "@/components/footer/footer.css";

// Import CodeBlock to define custom element
import CodeBlock from "@/components/CodeBlock.svelte";
import Loading from "@/components/Loading.astro";
import { covers } from "@/components/Images.astro";

// Accept sidebar props from child pages
interface PostMeta {
  date: Date;
  wordCount: number;
  readTime: number;
}

interface Props {
  toc?: TocItem[];
  relatedPosts?: RelatedPost[];
  currentSlug?: string;
  navigation?: QuickNavigation;
  pageTitle?: string;
  postMeta?: PostMeta;
  indexPage?: boolean;
}

const {
  toc = [],
  relatedPosts = [],
  currentSlug = "",
  navigation = {},
  pageTitle = "",
  postMeta,
  indexPage = false,
} = Astro.props;

const navLinks = themeConfig.nav;
const siteName = themeConfig.siteName;
const sidebarConfig = themeConfig.sidebar || {};
const brandConfig = themeConfig.brand || {};
const coverConfig = themeConfig.cover || {};
const footerConfig = themeConfig.footer || {};
const widgetsConfig = themeConfig.widgets || {};

// Get all posts for widgets
const allPosts = await getCollection("posts");
const posts = allPosts.filter((post) => !post.data.draft);

const siteState = {
  categories: allPosts.reduce((acc, post) => {
    post.data.categories?.forEach((category) => acc.add(category));
    return acc;
  }, new Set()).size,
  posts: posts.length,
  tags: allPosts.reduce((acc, post) => {
    post.data.tags?.forEach((tag) => acc.add(tag));
    return acc;
  }, new Set()).size,
};
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <slot name="head" />

    <meta http-equiv="X-Content-Type-Options" content="nosniff" />

    {
      themeConfig.cover?.enablePreload &&
        covers?.map((cover) => (
          <link rel="preload" as="image" href={cover.src} />
        ))
    }

    {
      themeConfig.cover?.fixedCover && themeConfig.cover.enablePreload && (
        <link rel="preload" as="image" href={themeConfig.cover.fixedCover} />
      )
    }

    <title>{pageTitle}</title>
    <script>
      // 方法1: 检查元素是否在 DOM 中但未渲染
      console.log(
        "DOMContentLoaded时main存在吗:",
        document.querySelector("main"),
      );

      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOMContentLoaded时main:", document.querySelector("main"));
      });

      window.addEventListener("load", () => {
        console.log("Load时main:", document.querySelector("main"));
      });

      // 方法2: 持续检查
      let checkCount = 0;
      const interval = setInterval(() => {
        const main = document.querySelector("main");
        console.log(`检查 ${checkCount++}:`, {
          exists: !!main,
          visible: main?.offsetParent !== null,
          computed: main ? getComputedStyle(main).display : "N/A",
        });

        if (checkCount > 20) clearInterval(interval);
      }, 100);
    </script>
  </head>
  <body>
    <div class="hidden">
      <CodeBlock client:only />
    </div>
    <!-- <Loading /> -->
    <div id="container">
      <HeaderCover
        enableCover={coverConfig.enableCover}
        enablePreload={coverConfig.enablePreload}
        fixedCover={coverConfig.fixedCover}
        gradient={coverConfig.gradient}
        covers={covers}
        title={brandConfig.title}
      />
      <Brand
        title={brandConfig.title}
        subtitle={brandConfig.subtitle}
        logo={brandConfig.logo}
        pageTitle={indexPage ? "" : pageTitle}
        postMeta={postMeta}
      />
      <NavBar
        client:load
        name={siteName}
        navLinks={navLinks}
        clickToggleCallback={() => void 0}
      />
      <Waves client:load />
      <main>
        <div class="inner">
          <div id="main" class="pjax">
            <slot />
            <footer id="footer">
              <div class="inner">
                <div class="widgets">
                  <Widgets
                    client:visible
                    posts={posts}
                    enableRandomPosts={widgetsConfig.randomPosts !== false}
                    enableRecentComments={widgetsConfig.recentComments !==
                      false}
                  />
                </div>
                <Footer
                  config={footerConfig}
                  siteName={siteName}
                  author={sidebarConfig.author}
                />
              </div>
            </footer>
          </div>
          <div id="sidebar" class="mt-12 mr-12">
            <Sidebar
              client:load
              config={sidebarConfig}
              navLinks={navLinks}
              toc={toc}
              relatedPosts={relatedPosts}
              currentSlug={currentSlug}
              navigation={navigation}
              siteState={siteState}
            />
          </div>
        </div>
      </main>
    </div>
    <script>
      import { css } from "@/assets/fonts/LXGWWenKai-Regular.ttf?subsets";

      document.addEventListener("pagereveal", () => {
        document.body.style.fontFamily = css.family as string;
      });
      document.addEventListener("DOMContentLoaded", () => {
        document.body.style.fontFamily = css.family as string;
      });
    </script>
    <script>
      import { initializeCodeBlock } from "@/toolkit/initCodeBlock";

      document.addEventListener("pagereveal", () => {
        initializeCodeBlock(".astro-code");
      });

      document.addEventListener("DOMContentLoaded", () => {
        initializeCodeBlock(".astro-code");
      });
    </script>
  </body>
</html>

<style>
  body {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
  }
</style>
