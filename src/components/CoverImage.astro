---
import themeConfig from '@/theme.config'
import type { ImageMetadata } from 'astro'
import { Picture } from 'astro:assets'
import { inferRemoteSize } from 'astro:assets'
import { getImage } from 'astro:assets'

interface Props {
  src: string | ImageMetadata
  alt: string
  index: number
  isListItem?: boolean
}

const {
  src,
  alt,
  index,
  isListItem = false,
} = Astro.props as Props

// 动画延迟（仅多图轮播）
const animationDelay = isListItem ? `${index * 6}s` : '0s'

let height = 1080,width = 1920
if (themeConfig.cover?.inferImageSize) {
  const size = await inferRemoteSize(src as string)
  height = size.height
  width = size.width
}

const bgImage = await getImage({
  src,
  height: height,
  width: width,
  format: 'avif',
  quality: 85,
})
---
{isListItem ? (
  <!-- 多图轮播模式 -->
  <li
    class="cover-item opacity-0 h-70vh w-full left-0 top-0 absolute z-0 bg-cover bg-center bg-no-repeat"
    style={`background-image: url('${bgImage.src}'); animation-delay: ${animationDelay};`}
    onmouseenter="this.classList.add('stop-animation')"
    onmouseleave="this.classList.remove('stop-animation')"
    ontouchstart="this.classList.add('stop-animation')"
    ontouchend="this.classList.remove('stop-animation')"
  ></li>
) : (
  <!-- 单图模式 -->
  <Picture
    src={src as ImageMetadata}
    alt={alt}
    height={1080}
    width={1920}
    layout='constrained'
    loading="eager"
    formats={["avif", "webp"]}
    fetchpriority="high"
    class="h-full w-full left-0 top-0 absolute object-cover"
  />
)}

<style>
  .cover-item {
    animation: imageAnimation 36s linear infinite 0s;
    backface-visibility: hidden;
    transform-style: preserve-3d;
  }

  .cover-item.stop-animation {
    animation-play-state: paused;
  }

  @keyframes imageAnimation {
    0% {
      opacity: 0;
      animation-timing-function: ease-in;
    }
    2% {
      opacity: 1;
    }
    8% {
      opacity: 1;
      transform: scale(1.05);
      animation-timing-function: ease-out;
    }
    17% {
      opacity: 1;
      transform: scale(1.1);
    }
    25% {
      opacity: 0;
      transform: scale(1.1);
    }
    100% {
      opacity: 0;
    }
  }
</style>
