---
interface Props {
  defaultValue?: string;
  class?: string;
}

const { defaultValue = "", class: className = "" }: Props = Astro.props;
---

<div class={`tabs ${className}`.trim()} data-default-value={defaultValue}>
  <div class="nav" aria-label="Tabs 导航">
    <ul role="tablist"></ul>
  </div>

  <div class="tabs-panels">
    <slot />
  </div>
</div>

<style is:global>
  .md .tabs {
    display: block;
    position: relative;
    margin: 0 0 2rem;
    border-radius: 0.5rem;
    border: 0.0625rem solid var(--grey-1-a7);
    background: var(--grey-1);
    box-shadow: 0 0.375rem 1.125rem
      color-mix(in srgb, var(--grey-9) 10%, transparent);
  }

  .md .tabs > .nav {
    border-bottom: 0.0625rem solid var(--grey-1-a7);
    min-height: 2.6875rem;
  }

  .md .tabs > .nav[hidden] {
    display: none;
  }

  .md .tabs > .nav > ul {
    display: flex;
    padding: 0;
    margin: 0;
    white-space: nowrap;
    overflow-x: auto;
    list-style: none;
  }

  .md .tabs > .nav li {
    position: relative;
    cursor: pointer;
    border: none;
    display: inline-block;
    padding: 0;
    margin: 0;
    color: var(--text-color);
  }

  .md .tabs > .nav button {
    all: unset;
    position: relative;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    line-height: 2;
    color: inherit;
    font-size: 0.95rem;
    padding: 0.3125rem 1.25rem 0.5rem;
  }

  .md .tabs > .nav button::before {
    content: "";
    position: absolute;
    left: 50%;
    bottom: 0.0625rem;
    width: 0.375rem;
    height: 0.1875rem;
    border-radius: 9999px;
    background: currentColor;
    transform: translateX(-50%);
    opacity: 0;
    transition:
      width 0.4s ease-in-out,
      transform 0.4s ease-in-out,
      left 0.4s ease-in-out,
      background-color 0.2s ease-in-out,
      opacity 0.2s ease-in-out;
  }

  .md .tabs > .nav li:hover:not(.active) > button::before,
  .md .tabs > .nav li:focus-within:not(.active) > button::before {
    width: 60%;
    opacity: 1;
  }

  .md .tabs > .nav li.active {
    color: var(--primary-color);
  }

  .md .tabs > .nav li.active > button::before {
    left: 0;
    width: 100%;
    border-radius: 0.25rem;
    background: var(--primary-color);
    transform: none;
    opacity: 1;
  }

  .md .tabs > .nav li.active > button {
    font-weight: 600;
  }

  .md .tabs .tabs-panels {
    padding: 1.25rem;
  }

  .md .tabs .tab-item {
    display: none;
    animation: tabs-fade-in 0.2s ease;
  }

  .md .tabs .tab-item.active {
    display: block;
  }

  .md .tabs .tab-item > :first-child {
    margin-top: 0;
  }

  .md .tabs .tab-item > :last-child {
    margin-bottom: 0;
  }

  @keyframes tabs-fade-in {
    from {
      opacity: 0;
      transform: translateY(0.125rem);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  // @ts-nocheck
  const DATA_BOUND_KEY = "tabsBound";

  /** @param {HTMLElement} root */
  const initTabs = (root) => {
    if (root.dataset[DATA_BOUND_KEY] === "true") {
      return;
    }

    const navList = root.querySelector(":scope > .nav > ul");
    const nav = root.querySelector(":scope > .nav");
    const tabItems = Array.from(
      root.querySelectorAll(":scope > .tabs-panels > .tab-item"),
    );

    if (!navList || tabItems.length === 0) {
      return;
    }

    const defaultValue = (root.dataset.defaultValue || "").trim();
    let activeIndex = 0;

    if (defaultValue.length > 0) {
      const matchedIndex = tabItems.findIndex((item) => {
        return (item.dataset.tabValue || "").trim() === defaultValue;
      });
      if (matchedIndex >= 0) {
        activeIndex = matchedIndex;
      }
    }

    const tabButtons = [];

    tabItems.forEach((item, index) => {
      const tabLabel =
        (item.dataset.tabLabel || "").trim() || `Tab ${index + 1}`;
      const tabValue =
        (item.dataset.tabValue || "").trim() || `tab-${index + 1}`;
      const panelId = `${tabValue}-panel-${index}`;
      const buttonId = `${tabValue}-tab-${index}`;

      item.id = panelId;
      item.setAttribute("role", "tabpanel");
      item.setAttribute("aria-labelledby", buttonId);

      const li = document.createElement("li");
      li.className = "tab-nav-item";
      li.setAttribute("role", "presentation");

      const button = document.createElement("button");
      button.type = "button";
      button.id = buttonId;
      button.setAttribute("role", "tab");
      button.setAttribute("aria-controls", panelId);
      button.textContent = tabLabel;

      button.addEventListener("click", () => {
        activate(index);
      });

      li.append(button);
      navList.append(li);
      tabButtons.push(button);
    });

    const activate = (index) => {
      tabItems.forEach((item, i) => {
        const isActive = i === index;
        item.classList.toggle("active", isActive);
        item.toggleAttribute("hidden", !isActive);
      });

      tabButtons.forEach((button, i) => {
        const isActive = i === index;
        button.parentElement?.classList.toggle("active", isActive);
        button.setAttribute("aria-selected", isActive ? "true" : "false");
        button.setAttribute("tabindex", isActive ? "0" : "-1");
      });
    };

    if (tabItems.length <= 1) {
      nav?.setAttribute("hidden", "true");
    }

    activate(activeIndex);
    root.dataset[DATA_BOUND_KEY] = "true";
  };

  const initAllTabs = () => {
    const tabsRoots = document.querySelectorAll(".md .tabs");
    tabsRoots.forEach((root) => {
      initTabs(root);
    });
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAllTabs, { once: true });
  } else {
    initAllTabs();
  }

  document.addEventListener("astro:page-load", initAllTabs);
</script>
