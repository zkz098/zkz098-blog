---
interface Props {
  currentPage: number;
  lastPage: number;
  /** 第一页链接，默认 '/' */
  firstPageHref?: string;
  /** 其他页前缀，默认 '/page'，最终会输出 `${routePrefix}/${n}/` */
  routePrefix?: string;
  ariaLabel?: string;
}

const {
  currentPage,
  lastPage,
  firstPageHref = "/",
  routePrefix = "/page",
  ariaLabel = "Pagination",
} = Astro.props;

const clampInt = (n: number) => Math.max(1, Math.floor(n || 1));
const safeCurrent = clampInt(currentPage);
const safeLast = clampInt(lastPage);

const getHref = (n: number) => {
  const pageNum = clampInt(n);
  if (pageNum <= 1) return firstPageHref;
  return `${routePrefix}/${pageNum}/`;
};

const prevHref = safeCurrent > 1 ? getHref(safeCurrent - 1) : undefined;
const nextHref = safeCurrent < safeLast ? getHref(safeCurrent + 1) : undefined;

function buildPageItems(current: number, last: number): Array<number | "…"> {
  if (last <= 1) return [1];

  // 小页数：全部展示
  if (last <= 7) {
    return Array.from({ length: last }, (_, i) => i + 1);
  }

  const items: Array<number | "…"> = [];
  const add = (v: number | "…") => {
    if (items.length === 0 || items[items.length - 1] !== v) items.push(v);
  };

  const windowStart = Math.max(2, current - 1);
  const windowEnd = Math.min(last - 1, current + 1);

  add(1);
  if (windowStart > 2) add("…");
  for (let p = windowStart; p <= windowEnd; p++) add(p);
  if (windowEnd < last - 1) add("…");
  add(last);

  return items;
}

const items = buildPageItems(safeCurrent, safeLast);
---

{
  safeLast > 1 && (
    <nav class="pagination" aria-label={ariaLabel}>
      <div class="inner">
        {prevHref ? (
          <a class="prev" href={prevHref} rel="prev">
            上一页
          </a>
        ) : null}

        {items.map((it) =>
          it === "…" ? (
            <span class="space" aria-hidden="true">
              …
            </span>
          ) : it === safeCurrent ? (
            <span class="page-number current" aria-current="page">
              {it}
            </span>
          ) : (
            <a class="page-number" href={getHref(it)}>
              {it}
            </a>
          ),
        )}

        {nextHref ? (
          <a class="next" href={nextHref} rel="next">
            下一页
          </a>
        ) : null}
      </div>
    </nav>
  )
}

<style>
  .pagination {
    width: 100%;
    padding: 1.25rem 3.125rem;
    text-align: center;
    display: inline-block;
    color: var(--grey-5);
  }

  .pagination .inner {
    width: auto;
    border-radius: 0.9375rem;
  }

  .pagination .prev,
  .pagination .next,
  .pagination .page-number,
  .pagination .space {
    display: inline-block;
    margin: 0 0.5rem;
    padding: 0 0.75rem;
    position: relative;
    border-radius: 0.3125rem;
  }

  .pagination .prev,
  .pagination .next,
  .pagination .page-number {
    transition:
      background-color 0.2s ease,
      color 0.2s ease,
      box-shadow 0.2s ease;
    color: inherit;
    text-decoration: none;
  }

  .pagination .prev:hover,
  .pagination .next:hover,
  .pagination .page-number:hover {
    background: var(--primary-color);
    color: var(--grey-0);
  }

  .pagination .space {
    margin: 0;
    padding: 0;
  }

  .pagination .prev {
    margin-left: 0;
  }

  .pagination .next {
    margin-right: 0;
  }

  .pagination .page-number.current {
    background: var(--primary-color);
    color: var(--grey-0);
  }

  .pagination .page-number.current:hover {
    box-shadow: 0 0 0.3125rem var(--primary-color);
  }

  @media (max-width: 500px) {
    .pagination {
      padding: 1.25rem 0.625rem;
    }

    .pagination .prev,
    .pagination .next,
    .pagination .page-number,
    .pagination .space {
      margin: 0 0.3125rem;
    }
  }
</style>
