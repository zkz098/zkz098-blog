---
import { t } from "@/i18n";

interface PostMeta {
  date: Date;
  wordCount: number;
  readTime: number;
}

interface Props {
  title?: string;
  subtitle?: string;
  logo?: string;
  pageTitle?: string;
  postMeta?: PostMeta;
}

const {
  title = "",
  subtitle = "",
  logo = "",
  pageTitle = "",
  postMeta,
} = Astro.props;

// Use pageTitle if provided (for non-index pages), otherwise use title from config
const displayTitle = pageTitle || title;
// Only show subtitle on index page (when no pageTitle) and no postMeta
const shouldShowSubtitle = !pageTitle && !postMeta && subtitle;
// Show postMeta for post pages
const shouldShowPostMeta = !!postMeta;

function formatDate(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

function formatWordCount(count: number): string {
  if (count >= 1000) {
    return `${(count / 1000).toFixed(1)}k`;
  }
  return String(count);
}
---

<div
  id="brand"
  class="color-[var(--grey-3)] w-full px-20 pt-12 text-center min-h-40 flex flex-col items-center justify-center"
>
  <div class="pjax flex flex-col w-full items-center justify-center">
    {
      logo && (
        <div class="artboard text-6xl leading-1.2 font-bold mb-2.5">{logo}</div>
      )
    }

    {
      displayTitle && (
        <h1 class="letter-space-2 text-5xl leading-tight tracking-wider font-600">
          {displayTitle}
        </h1>
      )
    }

    {
      shouldShowSubtitle && (
        <p class="text-2xl m-0 mt-2.5 flex gap-2.5">
          <span class="flex items-center">=</span>
          <span>{subtitle}</span>
          <span class="flex items-center">=</span>
        </p>
      )
    }

    {
      shouldShowPostMeta && postMeta && (
        <div class="meta text-base mt-2.5 opacity-80 flex flex-wrap gap-3 items-center justify-center">
          <span
            class="item flex gap-1 items-center"
            title={`${t("post.publishedAt")} ${formatDate(postMeta.date)}`}
          >
            <i class="i-ri-calendar-line" />
            <span class="text">{t("post.publishedAt")}</span>
            <time datetime={postMeta.date.toISOString()}>
              {formatDate(postMeta.date)}
            </time>
          </span>
          <span
            class="item flex gap-1 items-center"
            title={t("post.wordCount")}
          >
            <i class="i-ri-quill-pen-line" />
            <span class="text">{t("post.wordCount")}</span>
            <span>
              {formatWordCount(postMeta.wordCount)}
              {t("post.words")}
            </span>
          </span>
          <span
            class="item flex gap-1 items-center"
            title={t("post.readingTime")}
          >
            <i class="i-ri-time-line" />
            <span class="text">{t("post.readingTime")}</span>
            <span>
              {postMeta.readTime} {t("post.minutes")}
            </span>
          </span>
        </div>
      )
    }
  </div>
</div>

<!-- 滚动监听脚本 -->
<script>
  let isAffix = false;
  const brandElement = document.getElementById("brand");

  function handleScroll() {
    const shouldAffix = window.scrollY > 0;

    if (shouldAffix !== isAffix) {
      isAffix = shouldAffix;
      if (brandElement) {
        brandElement.classList.toggle("affix", isAffix);
      }
    }
  }

  // 初始化
  handleScroll();

  // 监听滚动
  window.addEventListener("scroll", handleScroll, { passive: true });
</script>

<style>
  #brand {
    z-index: auto;
    transition: all 0.3s ease;
    position: fixed;
    height: 50vh;
  }

  #brand.affix {
    z-index: 0;
  }

  .pjax {
    animation: slideDownIn 0.6s ease-out;
    /* 防止动画导致CLS，预留初始空间 */
    min-height: 1px;
  }

  @keyframes slideDownIn {
    from {
      opacity: 0;
      transform: translateY(-2rem);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    #brand {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
      padding-top: 3rem;
    }

    #brand h1 {
      font-size: 1.875rem;
    }
  }

  @media (max-width: 480px) {
    #brand .artboard {
      font-size: 2rem;
    }
  }
</style>
