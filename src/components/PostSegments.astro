---
import type { ImageMetadata } from 'astro'
import PostSegmentItem from './PostSegmentItem.astro'

export interface PostItem {
  title: string
  url: string
  date: Date
  excerpt: string
  cover?: ImageMetadata
  category?: string
  categoryUrl?: string
  wordCount?: number
  readTime?: number
}

interface Props {
  posts?: PostItem[]
}

const { posts = [] } = Astro.props
---

<div id="segment-container">
  {posts.map((post, index) => (
    <PostSegmentItem
      title={post.title}
      url={post.url}
      date={post.date}
      excerpt={post.excerpt}
      cover={post.cover}
      category={post.category}
      categoryUrl={post.categoryUrl}
      isEven={index % 2 === 1}
      lazy={index > 0}
      wordCount={post.wordCount}
      readTime={post.readTime}
    />
  ))}
</div>

<script type="module">
  const container = document.getElementById('segment-container')

  if (container) {
    const items = Array.from(
      container.querySelectorAll('article.segment-item')
    )

    if (items.length > 0) {
      const io = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.target.classList.contains('show')) {
              io.unobserve(entry.target)
            }
            else if (entry.isIntersecting || entry.intersectionRatio > 0) {
              entry.target.classList.add('show')
              io.unobserve(entry.target)
            }
          })
        },
        {
          root: null,
          threshold: [0.3],
        }
      )

      items.forEach(item => io.observe(item))

      // Show first item immediately
      if (items[0]) {
        items[0].classList.add('show')
      }
    }
  }
</script>

<style>
  #segment-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  article.segment-item {
    opacity: 0;
    transform: translateY(2rem);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    /* 防止动画引起的 CLS */
    min-height: 14rem;
    will-change: opacity, transform;
  }

  article.segment-item.show {
    opacity: 1;
    transform: translateY(0);
    will-change: auto;
  }
</style>
