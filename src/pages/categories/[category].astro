---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { getT } from "@/i18n";
import themeConfig from "@/theme.config";
import "../../styles/collapse.css";

export async function getStaticPaths() {
  const allPosts = await getCollection("posts");
  const publishedPosts = allPosts.filter((post) => !post.data.draft);

  // Collect all unique categories
  const categorySet = new Set<string>();
  publishedPosts.forEach((post) => {
    const categories = post.data.categories || [];
    categories.forEach((cat) => categorySet.add(cat));
  });

  // Generate paths for each category
  return Array.from(categorySet).map((category) => ({
    params: { category },
    props: { category },
  }));
}

interface Props {
  category: string;
}

const { category } = Astro.props;
const t = getT((themeConfig.locale as "zh-CN" | "en") || "zh-CN");

// Get all published posts
const allPosts = await getCollection("posts");
const publishedPosts = allPosts.filter((post) => !post.data.draft);

// Filter posts that belong to this category (at any level in hierarchy)
const postsInCategory = publishedPosts.filter((post) => {
  const categories = post.data.categories || [];
  return categories.includes(category);
});

// Sort posts by date ascending (older first, matching old project)
const sortedPosts = postsInCategory.sort(
  (a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime(),
);

// Build parent categories breadcrumb
function getParentCategories(categoryName: string): string[] {
  const parents: string[] = [];
  for (const post of publishedPosts) {
    const categories = post.data.categories || [];
    const index = categories.indexOf(categoryName);
    if (index > 0) {
      // Found the category, get all parents
      for (let i = 0; i < index; i++) {
        if (!parents.includes(categories[i])) {
          parents.push(categories[i]);
        }
      }
    }
  }
  return parents;
}

const parentCategories = getParentCategories(category);

// Group posts by their full subcategory path for rendering sections
interface PostDisplay {
  post: (typeof sortedPosts)[0];
  subcategoryPath: string[];
  subcategorySlug: string;
}

const postDisplays: PostDisplay[] = [];

sortedPosts.forEach((post) => {
  const categories = post.data.categories || [];
  const currentIndex = categories.indexOf(category);

  if (currentIndex >= 0) {
    // Build subcategory path (categories after current one)
    const subcategoryPath = categories.slice(currentIndex + 1);
    const subcategorySlug = subcategoryPath
      .map((c) => c.toLowerCase().replace(/\s+/g, "-"))
      .join("-");

    postDisplays.push({
      post,
      subcategoryPath,
      subcategorySlug,
    });
  }
});

function formatDate(date: Date): string {
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${month}-${day}`;
}

function getCategoryUrl(name: string): string {
  return `/categories/${encodeURIComponent(name)}/`;
}

// Track current subcategory slug to insert section headers
let currentSlug = "c";
---

<Layout pageTitle={category}>
  <div class="wrap">
    <div class="timeline">
      <h2 class="item header">
        <a href="/categories/">全部</a>
        {
          parentCategories.map((parent) => (
            <>
              <small>/</small>
              <a href={getCategoryUrl(parent)}>{parent}</a>
            </>
          ))
        }
        <small>/</small>
        {category}
        <small>{t("category.label")}</small>
      </h2>

      {
        postDisplays.map((display) => {
          const { post, subcategoryPath, subcategorySlug } = display;
          const needsHeader =
            subcategoryPath.length > 0 && subcategorySlug !== currentSlug;

          if (needsHeader) {
            currentSlug = subcategorySlug;
          }

          return (
            <>
              {needsHeader && (
                <h3 class="item section">
                  {subcategoryPath.map((cat, index) => (
                    <>
                      <a href={getCategoryUrl(cat)}>{cat}</a>
                      {index < subcategoryPath.length - 1 && <small>/</small>}
                    </>
                  ))}
                </h3>
              )}

              <article
                class="item normal"
                itemscope
                itemtype="http://schema.org/Article"
              >
                <div class="meta">
                  <time
                    itemprop="dateCreated"
                    datetime={post.data.date.toISOString()}
                  >
                    {formatDate(post.data.date)}
                  </time>
                </div>
                <div class="title">
                  {post.data.link ? (
                    <a
                      href={post.data.link}
                      class="external"
                      itemprop="url"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      {post.data.title || post.data.link}
                      <span class="i-ri-external-link-line" />
                    </a>
                  ) : (
                    <a href={`/posts/${post.id}/`} itemprop="url">
                      <span itemprop="name">{post.data.title || "无标题"}</span>
                    </a>
                  )}
                </div>
              </article>
            </>
          );
        })
      }

      {
        sortedPosts.length === 0 && (
          <div class="empty-state">
            <p>{t("category.noContent")}</p>
          </div>
        )
      }
    </div>
  </div>
</Layout>

<style>
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--grey-5);
  }
</style>
