---
import Layout from "@/layouts/Layout.astro";
import IndexContent from "@/components/IndexContent.astro";
import Pagination from "@/components/Pagination.astro";
import { getCollection } from "astro:content";
import themeConfig from "@/theme.config";
import type { CollectionEntry } from "astro:content";
import type { GetStaticPaths } from "astro";

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = await getCollection("posts");
  const publishedPosts = allPosts.filter((post) => !post.data.draft);

  const regularPosts = publishedPosts
    .filter((post) => !post.data.sticky)
    .sort(
      (a, b) =>
        new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
    );

  const pageSize = themeConfig.home?.pageSize ?? 10;

  // Astro 原生分页：生成 /page/1, /page/2 ...
  // 但我们只输出 /page/2..N，第一页交给 src/pages/index.astro（输出 index.html）
  const pages = paginate(regularPosts, { pageSize });
  return pages.filter((p) => p.params.page !== "1");
}) satisfies GetStaticPaths;

const { page } = Astro.props as {
  page: {
    data: CollectionEntry<"posts">[];
    currentPage: number;
    lastPage: number;
  };
};

const pageTitle = `${themeConfig.brand?.logo || ""} = ${themeConfig.brand?.title || ""} = ${themeConfig.brand?.subtitle || ""} - 第${page.currentPage}页`;

// Build pagination navigation
const paginationNavigation = {
  prevUrl:
    page.currentPage > 1
      ? page.currentPage === 2
        ? "/"
        : `/page/${page.currentPage - 1}/`
      : undefined,
  nextUrl:
    page.currentPage < page.lastPage
      ? `/page/${page.currentPage + 1}/`
      : undefined,
};
---

<Layout
  pageTitle={pageTitle}
  indexPage={true}
  navigation={paginationNavigation}
>
  <Fragment slot="head">
    <meta name="description" content={themeConfig.sidebar?.description} />
  </Fragment>

  <IndexContent
    posts={page.data}
    stickyPosts={[]}
    categories={[]}
    isFirstPage={false}
  />
  <Pagination
    currentPage={page.currentPage}
    lastPage={page.lastPage}
    firstPageHref="/"
    routePrefix="/page"
  />
</Layout>
