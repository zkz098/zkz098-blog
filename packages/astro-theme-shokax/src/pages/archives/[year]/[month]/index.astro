---
import Layout from '../../../../layouts/Layout.astro'
import { getCollection } from 'astro:content'
import { structurePostsByDate, fmtNum } from 'shokax-toolkit-lib'
import '../../../../styles/collapse.css'

export async function getStaticPaths() {
  const allPosts = await getCollection('posts')
  const publishedPosts = allPosts
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

  const structuredPosts = structurePostsByDate(
    publishedPosts.map((post) => ({
      _id: post.id,
      title: post.data.title,
      content: '',
      date: post.data.date,
      categories: post.data.categories || [],
      link: post.data.link,
    })),
    { daily: false },
  )

  const paths = []

  for (const year of Object.keys(structuredPosts).map(Number)) {
    const yearData = structuredPosts[year]

    // Get all months that have posts in this year
    for (let month = 1; month <= 12; month++) {
      if (yearData[month] && yearData[month].length > 0) {
        paths.push({
          params: {
            year: String(year),
            month: fmtNum(month),
          },
          props: {
            year,
            month,
            posts: yearData[month],
          },
        })
      }
    }
  }

  return paths
}

const { year, month, posts } = Astro.props as {
  year: number
  month: number
  posts: {
    _id: string
    title: string
    content: string
    date: Date
    categories: string[]
    link?: string
  }[]
}

// Helper to get category URL
function getCategoryUrl(category: string): string {
  return `/categories/${encodeURIComponent(category)}`
}

// Helper to format date
function formatDate(date: Date): string {
  const m = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  return `${m}-${day}`
}
---

<Layout pageTitle={`${year} 年 ${month} 月归档`}>
  <div class="wrap">
    <div class="timeline">
      <h2 class="item header">
        <a href="/archives">全部</a>
        <small>/</small>
        <a href={`/archives/${year}`}>
          {year} 年
        </a>
        <small>/</small>
        {month} 月
        <small>归档</small>
      </h2>

      {
        posts.map((post) => {
          const postDate = post.date

          return (
            <article class="item normal" itemscope itemtype="http://schema.org/Article">
              <div class="meta">
                <time itemprop="dateCreated" datetime={postDate.toISOString()}>
                  {formatDate(postDate)}
                </time>
              </div>

              {post.categories && post.categories.length > 0 && (
                <div class="meta">
                  {post.categories.map((cat, catIndex) => (
                    <>
                      {catIndex === post.categories.length - 1 && (
                        <span>
                          <a href={getCategoryUrl(cat)}>{cat}</a>
                        </span>
                      )}
                    </>
                  ))}
                </div>
              )}

              <div class="title">
                {post.link ? (
                  <a href={post.link} class="external" itemprop="url" target="_blank" rel="noopener noreferrer">
                    <span itemprop="name">{post.title || post.link}</span>
                    <i class="i-ri-external-link-line" />
                  </a>
                ) : (
                  <a href={`/posts/${post._id.replace(/\.md$/, '')}`} itemprop="url">
                    <span itemprop="name">{post.title || '未命名'}</span>
                  </a>
                )}
              </div>
            </article>
          )
        })
      }
    </div>
  </div>
</Layout>

<style>
  .wrap {
    max-width: 60rem;
    margin: 0 auto;
    padding: 2rem 1rem;
  }
</style>
