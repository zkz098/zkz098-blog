---
import type { CollectionEntry } from 'astro:content'
import PostSegments from './PostSegments.svelte'
import CategoryCards from './CategoryCards.svelte'
import Divider from './Divider.astro'

interface CategoryItem {
  name: string
  url: string
  cover?: string
  topCategory?: {
    name: string
    url: string
  }
  postCount: number
  childCount?: number
  posts: Array<{ title: string; url: string }>
}

interface Props {
  posts: CollectionEntry<'posts'>[]
  stickyPosts?: CollectionEntry<'posts'>[]
  categories?: CategoryItem[]
  isFirstPage?: boolean
}

const { posts, stickyPosts = [], categories = [], isFirstPage = true } = Astro.props

// Helper function to calculate word count
function calculateWordCount(text: string): number {
  // Remove HTML tags and count words
  const plainText = text.replace(/<[^>]*>/g, '')
  // Count Chinese characters and English words
  const chineseChars = (plainText.match(/[\u4e00-\u9fa5]/g) || []).length
  const englishWords = (plainText.match(/[a-zA-Z]+/g) || []).length
  return chineseChars + englishWords
}

// Helper function to calculate read time (assuming 300 words per minute)
function calculateReadTime(wordCount: number): number {
  const wordsPerMinute = 300
  return Math.ceil(wordCount / wordsPerMinute)
}

// Helper function to transform posts
function transformPosts(postList: CollectionEntry<'posts'>[]) {
  return postList.map((post) => {
    const wordCount = calculateWordCount(post.body || '')
    const readTime = calculateReadTime(wordCount)
    const lastCategory = post.data.categories?.[post.data.categories.length - 1]

    return {
      title: post.data.title,
      url: `/posts/${post.id}`,
      date: post.data.date,
      excerpt: post.data.description || post.body?.substring(0, 300) || '',
      cover: post.data.cover,
      category: lastCategory,
      categoryUrl: lastCategory ? `/categories/${lastCategory}` : undefined,
      wordCount,
      readTime,
    }
  })
}

const transformedStickyPosts = transformPosts(stickyPosts)
const transformedPosts = transformPosts(posts)
---

<div class="index wrap">
  {
    isFirstPage && transformedStickyPosts.length > 0 && (
      <>
        <Divider title="置顶文章" />
        <div class="segments sticky">
          <PostSegments posts={transformedStickyPosts} client:load />
        </div>
      </>
    )
  }

  {
    isFirstPage && categories.length > 0 && (
      <>
        <Divider title="分类" />
        <div class="cards">
          <CategoryCards categories={categories} client:load />
        </div>
      </>
    )
  }

  {
    transformedPosts.length > 0 ? (
      <>
        {isFirstPage && <Divider title="最新文章" />}
        <div class="segments posts">
          <PostSegments posts={transformedPosts} client:load />
        </div>
      </>
    ) : (
      <div class="no-posts">
        <p>暂无文章</p>
      </div>
    )
  }
</div>

<style>
  .index.wrap {
    position: relative;
    padding: 1.25rem;
  }

  .segments {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .segments.sticky,
  .segments.posts {
    margin: 0;
    width: 100%;
  }

  .cards {
    display: flex;
    margin: 0 auto;
    align-items: center;
    flex-wrap: wrap;
    justify-content: space-between;
  }

  .no-posts {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--grey-5);
  }

  .no-posts p {
    font-size: 1.125rem;
  }

  @media (max-width: 820px) {
    .index.wrap {
      padding: 0.625rem;
    }
  }

  @media (max-width: 500px) {
    .index.wrap {
      padding: 0.5rem;
    }
  }
</style>
